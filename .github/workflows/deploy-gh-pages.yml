name: Deploy Blazor to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore and publish
        run: |
          # publish the Blazor WebAssembly project
          dotnet restore
          dotnet publish ./BeMyValentine/BeMyValentine.csproj -c Release -o publish

      - name: Patch index.html base href for GitHub Pages
        run: |
          set -euo pipefail
          repo_raw="${GITHUB_REPOSITORY#*/}"
          repo_encoded="$(python3 -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]))" "$repo_raw")"

          # If this is a user/organization site (owner.github.io) use root '/', otherwise use '/repo/'
          if [[ "${repo_raw,,}" =~ \.github\.io$ ]]; then
            base_value="/"
          else
            base_value="/$repo_encoded/"
          fi

          echo "Setting <base href> to '$base_value'"

          index_path="$(find . -type f -path "*/publish/wwwroot/index.html" -print -quit || true)"
          if [ -z "$index_path" ]; then
            echo "ERROR: publish/wwwroot/index.html not found"
            exit 1
          fi

          echo "Patching $index_path"
          cp -- "$index_path" "$index_path.bak" || true
          tmp="$(mktemp)"

          # Replace existing <base href=...> if present (handles single/double quotes and optional whitespace)
          perl -0777 -pe "s|<base\s+href\s*=\s*([\"'])(.*?)\1\s*/?>|<base href=\"${base_value}\">|i" "$index_path" > "$tmp"
          if cmp -s "$index_path" "$tmp"; then
            # no change by replacement; try inserting if no <base> exists
            if ! grep -qi "<base\b" "$index_path"; then
              perl -0777 -pe "s|(<head[^>]*>)|\1\n    <base href=\"${base_value}\">|i" "$index_path" > "$tmp" && mv -- "$tmp" "$index_path" && echo "Inserted <base> into <head>"
            else
              echo "No replacement needed (existing <base> unchanged)"
            fi
          else
            mv -- "$tmp" "$index_path"
            echo "Replaced existing <base> in $index_path"
          fi

          # Show resulting base line for logs
          grep -i "<base" "$index_path" || echo "No <base> tag present after modifications"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish/wwwroot
          publish_branch: gh-pages
          # keep the history for easier rollbacks
          keep_files: false
